---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# xmlwriter

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/xmlwriter)](https://CRAN.R-project.org/package=xmlwriter)
[![R-CMD-check](https://github.com/edwindj/xmlwriter/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/edwindj/xmlwriter/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

`xmlwriter` is an R package that provides a simple interface for creating XML documents 
and fragments from R. It provides a simple elegant syntax for creating `xml_fragment`s and furthermore
contains a feed-forward API that allows you to write xml
in the same order as the xml elements appear in an xml document or fragment.

`xmlwriter`'s xml generation from R lists is fast, 
implemented in C++ using [`Rcpp`](https://cran.r-project.org/package=Rcpp). 
Curious for the benchmarks? Check the [performance section](#performance).

`xmlwriter` can be used as a companion to R packages [`XML`](https://cran.r-project.org/package=XML) or [`xml2`](https://cran.r-project.org/package=xml2) which are both wonderful packages optimized for parsing,
querying and manipulating XML documents. Both `XML` and `xml2` provide several 
ways for creating xml documents, but they are not optimized for 
generating and writing xml.

Creating xml documents with `XML` and `xml2` can be a bit cumbersome, mostly
because it  
forces the author to manipulate the xml document tree by adding nodes and attributes.
`xml2` _does_ provide a way to create xml documents from R data structures using
nested lists which is a powerful feature, but it is not optimized for 
speed or readability.

`xmlwriter` provides an intuitive interface for creating xml documents, 
that mimicks how xml is written in a text editor.

It has two different ways to create xml documents:

**NOTE the api is still in flux, and might change before `xmlwriter` is put on CRAN**

- a light weight R syntax using `xml_fragment` and `frag`, creating 
an `xml_fragment`, that can be easily translated into a xml string or 
`xml2::xml_document` object, or be used as a flexible building block for generating
a larger xml document.
- an `xmlbuilder` object that allows you to create xml documents in a 
feed-forward manner, with `start` and `end` methods, giving you more control on the xml document structure, including xml comment, prolog etc.

## Installation

`xmlwriter` is not yet available on CRAN, feedback is welcome before submitting to CRAN.

You can install the development version of `xmlwriter` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("edwindj/xmlwriter")
```

## Example

### Using `xml_fragment`, `frag` and `.attr`:

`xml_fragment` is a function that creates an xml fragment using readable R syntax.
It can be used to create an `character` with valid xml, a `xml2::xml_document` 
or as a building block for more complex XML documents.
Each argument to `xml_fragment` is either:

- a named `frag` element in which case the name is used as the tag name.
- an unnamed element in which case the element is added as a text node.
- a `.attr` argument that is used to add attributes to the root element.

`frag` have the same structure as `xml_fragment`, so you can nest them to 
create a complex xml document.
The output of `xml_fragment` is a list object that is identical to the output
of `xml2::as_list`, and can be converted to an 
`xml2::xml_document` or `character` string, but is much faster.


```{r fragment}
library(xmlwriter)

fragment <- xml_fragment(
  person = frag(
    .attr = c(id = "1"),
    name = "John Doe",
    age = 30,
    address = frag(
       street = "123 Main St",
       city = "Anytown",
       state = "CA",
       zip = 12345
    )
  )
)

print(fragment)
fragment |> xml2::as_xml_document()
fragment |> as_xml_nodeset()
```
#### Extend with `append_frag`, `c()` and `+`

`xml_fragment` can be extended with `append_frag`, `c()` and `+` functions.

- `append_frag()` is a function that adds a `frag` to an existing `xml_fragment`, with
a given tag name. This allow for building up a complex xml document in a bottom up manner


- `c()` is a function that combines two `xml_fragment` objects into a single `xml_fragment`

```{r}
library(xmlwriter)
f <- xml_fragment(node = frag("fragment", .attr = c(id="f")))
sib <- xml_fragment(node = frag("sibling", .attr = c(id = "sib")))
child <- xml_fragment("child")

# add a sibling to f
f + sib

# same as:
c(f, sib)

sub <- xml_fragment(sub = "subsibling")
# add a fragment with a supplied tag name
f |> append_frag("node", sub, id = "sibling") 

f |> add_child("node", child, id = "child")
```

`xml_fragment` implements the `xml2::write_xml` method

```{r write_xml, eval=FALSE}
xml2::write_xml(fragment, file="") # print to the console
```

results in:

```{r, echo=FALSE, results='asis'}
cat("```XML\n")
xml2::write_xml(fragment, "")
cat("\n```\n")
```

`xml_fragment` provides a `.data` function that can be used to convert a data.frame to xml:

```{r data}
data <- data.frame(
  name = c("John Doe", "Jane Doe"),
  age = c(30, 25),
  stringsAsFactors = FALSE
)

# xml_doc is a xml_fragment that contains a single root element
doc <- xml_doc(
  homeless = frag(
    .attr = c(year = "1900"),
    data = .data(data, row_tag = "person")
  )
)

doc
```
Both `xml_doc` as well as `xml_fragment` can be used to create a single root element xml document.
`xml_doc` is a `xml_fragment` that errors when there is more than one root element.

### Using an `xmlbuilder` object

`xmlbuilder` is an object that allows you to create xml documents in a feed-forward manner.

With `xml_fragment` one creates the xml document structure as one R list and 
then converts it to a xml string or `xml2::xml_document`, with `xmlbuilder` one
incremently builds the xml document, without having the whole list structure in memory.
It also provides more functions for the output xml document, like adding a prolog or comment.

It provides the following methods:

- `start` to start a new element
- `end` to end the current element
- `element` to add an element with a value
- `comment` to add a comment
- `prolog` to add a prolog
- `fragment` to add a fragment

```{r xmlbuilder}
library(xmlwriter)

b <- xmlbuilder(allow_fragments = FALSE)
b$comment("This is an xml comment")
b$start("homeless")
  b$start("person", id = "1")
    b$element("name", "John Doe")
    b$element("age", 30)
    b$start("address")
      b$element("street", "123 Main St")
      b$element("city", "Anytown")
      b$element("state", "CA")
      b$element("zip", 12345)
    b$end("address")
  b$end("person")
  b$start("person", id = "2")
    b$element("name", "Jane Doe")
    b$element("age", 25)
    b$start("address")
      b$element("street", "321 Main St")
      b$element("city", "Anytown")
      b$element("state", "CA")
      b$element("zip", 54321)
    b$end("address")
  b$end("person")
  b$fragment(
    person = frag(
      .attr = c(id = "3"),
      name = "Jim Doe",
      age = 35
    )
  )
b$end("homeless")

# includes a xml prolog and comment
b

as.character(b)

# only contains the actual nodes
xml2::as_xml_document(b)
```


# Performance

`xmlwriter` is optimized for generating xml documents and fragments from a R `list`
structure that is identical to the `xml2::as_list` output.

```{r performance, eval=TRUE}
library(microbenchmark)

library(xml2)
library(xmlwriter)

# read in a sample 600k xml file as a R list str
doc <- xml2::read_xml("./example/DataGeneric.xml")
doc_list <- xml2::as_list(doc)

# just copy the list and set an extra attribute class="xml_fragment"
# making it a xml_fragment object
doc_fragment <- structure(doc_list, class = "xml_fragment")

# see how long it takes to create an xml document with xml2 and xmlwriter

microbenchmark(
  xml2      = xml2::as_xml_document(doc_list),
  xmlwriter = xml2::as_xml_document(doc_fragment),
  times     = 10
)

```
